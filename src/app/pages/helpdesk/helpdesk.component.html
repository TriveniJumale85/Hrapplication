<div class="">
  <h2 class="mb-2 text-center">Help Desk Tickets</h2>
</div>

<!-- Raise Ticket Button -->
<div class="text-end mb-2">
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ticketModal">
    <i class="bi bi-plus-circle me-1"></i> Raise Ticket
  </button>
</div>

<!-- Ticket Modal -->
<div class="modal fade" id="ticketModal" tabindex="-1" aria-labelledby="ticketModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="ticketModalLabel">Create New Ticket</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <form [formGroup]="ticketForm" (ngSubmit)="onSubmit()" novalidate>
          <div class="card mb-4">
            <div class="card-body">
              <div class="row g-3">
                <!-- Category -->
                <div class="col-md-6">
                  <label for="categorySelect" class="form-label">Select Category</label>
                  <select class="form-select" id="categorySelect" name="category" formControlName="category"
                    [class.is-invalid]="ticketForm.get('category')?.invalid && ticketForm.get('category')?.touched">
                    <option selected disabled>Choose a category</option>
                    <option value="employee">Employee Information</option>
                    <option value="tax">Income Tax</option>
                    <option value="loan">Loan</option>
                    <option value="payslip">Payslip</option>
                    <option value="other">Other</option>
                  </select>
                  <div *ngIf="ticketForm.get('category')?.invalid && ticketForm.get('category')?.touched"
                    class="invalid-feedback">
                    <span *ngIf="ticketForm.get('category')?.errors?.['required']">Category is required</span>
                  </div>
                </div>

                <!-- Subject -->
                <div class="col-md-6">
                  <label for="subject" class="form-label">Subject</label>
                  <input type="text" class="form-control" id="subject" formControlName="subject"
                    [class.is-invalid]="ticketForm.get('subject')?.invalid && ticketForm.get('subject')?.touched" />
                  <div *ngIf="ticketForm.get('subject')?.invalid && ticketForm.get('subject')?.touched"
                    class="invalid-feedback">
                    <span *ngIf="ticketForm.get('subject')?.errors?.['required']">Subject is required</span>
                  </div>
                </div>

                <!-- Description -->
                <div class="col-12">
                  <label for="description" class="form-label">Description</label>
                  <textarea class="form-control" id="description" rows="3" formControlName="description"
                    [class.is-invalid]="ticketForm.get('description')?.invalid && ticketForm.get('description')?.touched"></textarea>
                  <div *ngIf="ticketForm.get('description')?.invalid && ticketForm.get('description')?.touched"
                    class="invalid-feedback">
                    <span *ngIf="ticketForm.get('description')?.errors?.['required']">Description is required</span>
                  </div>
                </div>

                <!-- Priority -->
                <div class="col-md-6">
                  <label for="priority" class="form-label">Priority</label>
                  <select class="form-select" id="priority" formControlName="priority"
                    [class.is-invalid]="ticketForm.get('priority')?.invalid && ticketForm.get('priority')?.touched">
                    <option *ngFor="let priority of priorities" [value]="priority">{{ priority }}</option>
                  </select>
                </div>

                <!-- File Upload -->
                <div class="col-12">
                  <label for="file" class="form-label">Attachment</label>
                  <input type="file" class="form-control" id="file" (change)="onFileSelected($event)" />
                  <small class="text-muted">Max file size: 10MB</small>
                </div>

                <!-- Progress Bar -->
                <div class="col-12" *ngIf="fileUploadProgress !== null">
                  <div class="progress">
                    <div class="progress-bar" [style.width.%]="fileUploadProgress" role="progressbar">
                      {{ fileUploadProgress }}%
                    </div>
                  </div>
                </div>

                <!-- Submit -->
                <div class="col-12">
                  <button type="submit" class="btn btn-primary" [disabled]="isLoading">
                    <span *ngIf="!isLoading">Submit Ticket</span>
                    <span *ngIf="isLoading" class="spinner-border spinner-border-sm"></span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Tickets Table -->
<div *ngIf="tickets" class="">
  <h4 class="text-center text-white ">Applied Tickets</h4>
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>#</th>
        <th>Category</th>
        <th>Subject</th>
        <th>Description</th>
        <th>Priority</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let ticket of tickets; let i = index">
        <td>{{ i + 1 }}</td>
        <td>{{ ticket.category }}</td>
        <td>{{ ticket.subject }}</td>
        <td>{{ ticket.description }}</td>
        <td>
          <span class="badge" [ngClass]="getPriorityClass(ticket.priority)">
            {{ ticket.priority }}
          </span>
        </td>
        <td>
          <span class="badge bg-info text-dark">{{ ticket.helpDeskStatus }}</span>
        </td>
      </tr>
    </tbody>
  </table>
</div>
